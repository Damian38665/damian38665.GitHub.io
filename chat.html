<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 样式部分 -->
    <script>
        // 初始化聊天室
        let currentPage = 1;
        const pageSize = 10;

        async function loadMessages() {
            const res = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/chat.json', {
                headers: { Authorization: 'Bearer 9e4e0289fbbcbbf9646aac16d1fe007a' }
            });
            const data = await res.json();
            const messages = JSON.parse(atob(data.content));
            
            // 分页显示
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            renderMessages(messages.slice(start, end));
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatContainer');
            container.innerHTML = messages.map(msg => `
                <div class="message-card ${msg.sender === localStorage.getItem('username') ? 'own-message' : ''}">
                    <div class="message-header">
                        <span class="sender">${msg.sender}</span>
                        <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                        ${isAdmin() ? `<button class="btn btn-sm btn-danger" onclick="deleteMessage('${msg.id}')">删除</button>` : ''}
                    </div>
                    <div class="message-body">${msg.content}</div>
                </div>
            `).join('');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = {
                id: Date.now().toString(),
                sender: localStorage.getItem('username'),
                content: input.value,
                timestamp: new Date().toISOString()
            };

            // 更新到Gitee
            const res = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/chat.json', {
                headers: { Authorization: 'Bearer 9e4e0289fbbcbbf9646aac16d1fe007a' }
            });
            const data = await res.json();
            const messages = JSON.parse(atob(data.content)) || [];
            messages.push(message);

            await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/chat.json', {
                method: 'PUT',
                headers: { Authorization: 'Bearer 9e4e0289fbbcbbf9646aac16d1fe007a' },
                body: JSON.stringify({
                    content: btoa(JSON.stringify(messages)),
                    message: '新聊天消息',
                    sha: data.sha
                })
            });

            input.value = '';
            loadMessages();
        }

        function isAdmin() {
            return localStorage.getItem('username') === 'admin';
        }

        // 每5秒刷新
        setInterval(loadMessages, 5000);
        loadMessages();
    </script>
</head>
<body>
    <div class="container py-4">
        <div class="glass-card p-4">
            <h2 class="text-center mb-4">聊天室</h2>
            <div id="chatContainer" class="mb-3" style="height: 60vh; overflow-y: auto;"></div>
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="输入消息...">
                <button class="btn btn-primary" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>
</body>
</html>
