<div id="pointsCenter" class="container glass-container mt-5 p-4" style="display: none;">
    <h2 class="text-center mb-4">积分中心</h2>
    
    <!-- 用户积分信息 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">我的积分</h5>
                    <p class="display-4" id="userPoints">0</p>
                    <button class="btn feature-btn w-100" id="checkInBtn" onclick="checkIn()">每日签到</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">签到记录</h5>
                    <ul class="list-group" id="checkInHistory">
                        <!-- 签到记录将动态加载到这里 -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 积分排行榜 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">积分排行榜</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>用户名</th>
                        <th>积分</th>
                    </tr>
                </thead>
                <tbody id="leaderboard">
                    <!-- 排行榜数据将动态加载到这里 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 返回按钮 -->
    <button class="btn feature-btn w-100" onclick="backToMain()">返回首页</button>
</div>

<script>
    // 积分中心相关逻辑
    let currentUser = null;
    let lastCheckInDate = null;

    // 显示积分中心
    function showPointsCenter() {
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('pointsCenter').style.display = 'block';
        loadPointsData();
    }

    // 返回首页
    function backToMain() {
        document.getElementById('pointsCenter').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
    }

    // 加载积分数据
    async function loadPointsData() {
        try {
            // 从Gitee获取积分数据
            const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/qq.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
            const data = await response.json();
            const pointsData = JSON.parse(atob(data.content));

            // 更新用户积分
            const userData = pointsData.users.find(u => u.username === currentUser);
            if (userData) {
                document.getElementById('userPoints').textContent = userData.points;
                lastCheckInDate = userData.lastCheckIn;
                updateCheckInButton();
                updateCheckInHistory(userData.history);
            }

            // 更新排行榜
            updateLeaderboard(pointsData.users);
        } catch (error) {
            console.error('加载积分数据失败:', error);
        }
    }

    // 更新签到按钮状态
    function updateCheckInButton() {
        const checkInBtn = document.getElementById('checkInBtn');
        const today = new Date().toLocaleDateString();
        if (lastCheckInDate === today) {
            checkInBtn.disabled = true;
            checkInBtn.textContent = '今日已签到';
        } else {
            checkInBtn.disabled = false;
            checkInBtn.textContent = '每日签到';
        }
    }

    // 更新签到历史
    function updateCheckInHistory(history) {
        const historyList = document.getElementById('checkInHistory');
        historyList.innerHTML = history.map(date => `
            <li class="list-group-item">${date}</li>
        `).join('');
    }

    // 更新排行榜
    function updateLeaderboard(users) {
        const leaderboard = document.getElementById('leaderboard');
        const sortedUsers = users.sort((a, b) => b.points - a.points).slice(0, 10);
        leaderboard.innerHTML = sortedUsers.map((user, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${user.username}</td>
                <td>${user.points}</td>
            </tr>
        `).join('');
    }

    // 签到功能
    async function checkIn() {
        try {
            const today = new Date().toLocaleDateString();
            const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/qq.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
            const data = await response.json();
            const pointsData = JSON.parse(atob(data.content));

            // 更新用户数据
            const userData = pointsData.users.find(u => u.username === currentUser);
            if (userData) {
                userData.points += 2;
                userData.lastCheckIn = today;
                userData.history.push(today);
            }

            // 更新Gitee数据
            await updatePointsData(pointsData);

            // 刷新显示
            loadPointsData();
        } catch (error) {
            console.error('签到失败:', error);
        }
    }

    // 更新Gitee数据
    async function updatePointsData(newData) {
        const content = btoa(JSON.stringify(newData));
        const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/qq.txt', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                access_token: '247bbba741389d3b55d3d126e0a249f9',
                content: content,
                message: '更新积分数据',
                sha: await getFileSHA()
            })
        });
        return response.json();
    }

    // 获取文件SHA
    async function getFileSHA() {
        const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/qq.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
        const data = await response.json();
        return data.sha;
    }
</script>
