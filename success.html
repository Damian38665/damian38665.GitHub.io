<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; }
        .profile-box { 
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-box">
            <h3 class="text-center mb-4">个人中心</h3>
            <div id="profileInfo"></div>
            <form id="changePasswordForm">
                <div class="mb-3">
                    <input type="password" class="form-control" placeholder="新密码" id="newPassword" required>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control" placeholder="确认新密码" id="confirmNewPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">修改密码</button>
            </form>
            <button id="logoutButton" class="btn btn-danger w-100 mt-3">注销</button>
        </div>
    </div>

    <script>
        // 检查用户是否登录
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const currentUser = localStorage.getItem('currentUser');

        if (!isLoggedIn || !currentUser) {
            window.location.href = 'index.html'; // 未登录则跳转到登录页面
        }

        // 显示用户信息
        document.getElementById('profileInfo').innerHTML = `
            <p><strong>用户名：</strong>${currentUser}</p>
        `;

        // 修改密码
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                alert('两次密码输入不一致');
                return;
            }

            try {
                const content = await getFileContent();
                const users = content.split('\n').filter(line => line.trim() !== '');
                const userIndex = users.findIndex(user => user.startsWith(currentUser + ':'));
                
                if (userIndex === -1) {
                    alert('用户不存在');
                    return;
                }

                users[userIndex] = `${currentUser}:${newPassword}`; // 更新密码
                const newContent = users.join('\n');
                await updateFileContent(newContent);
                alert('密码修改成功！');
            } catch (error) {
                alert('密码修改失败: ' + error.message);
            }
        });

        // 注销
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html'; // 跳转到登录页面
        });

        // Gitee API 相关操作
        async function getFileContent() {
            const url = `https://gitee.com/api/v5/repos/${owner}/${repo}/contents/${filePath}`;
            const response = await fetch(url, {
                headers: { 'Authorization': `token ${token}` }
            });

            if (!response.ok) throw new Error('获取文件失败');
            const data = await response.json();
            if (!data.content) throw new Error('文件内容为空');
            return decodeBase64(data.content);
        }

        async function updateFileContent(newContent) {
            const url = `https://gitee.com/api/v5/repos/${owner}/${repo}/contents/${filePath}`;
            const { sha } = await (await fetch(url, {
                headers: { 'Authorization': `token ${token}` }
            })).json();

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: encodeBase64(newContent),
                    sha,
                    message: '更新用户数据'
                })
            });

            if (!response.ok) throw new Error('更新文件失败');
        }

        // Base64 编码和解码
        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function decodeBase64(str) {
            return decodeURIComponent(escape(atob(str)));
        }
    </script>
</body>
  </html>
