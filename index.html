<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2196F3;
            --success: #4CAF50;
            --danger: #f44336;
            --background: #f8f9fa;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .auth-switch {
            display: flex;
            margin-bottom: 2rem;
            position: relative;
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            color: #666;
            position: relative;
        }

        .auth-tab.active {
            color: var(--primary);
        }

        .auth-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--primary);
            transition: 0.3s;
        }

        .auth-tab.active::after {
            width: 100%;
            left: 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--primary);
            outline: none;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .dashboard, .admin-dashboard {
            display: none;
        }

        .points {
            font-size: 3rem;
            text-align: center;
            margin: 2rem 0;
            color: var(--primary);
        }

        .checkin-btn {
            background: var(--success);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.show {
            transform: translateX(0);
        }

        .admin-dashboard .form-group {
            margin-bottom: 1rem;
        }

        .admin-dashboard label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
        }

        .admin-dashboard button {
            margin: 0.5rem 0;
        }

        .admin-dashboard button.danger {
            background: var(--danger);
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading.show {
            display: flex;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-list {
            margin-top: 1rem;
        }

        .user-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: 0.3s;
        }

        .user-item:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div class="container auth-container">
        <div class="auth-switch">
            <div class="auth-tab active" onclick="switchTab('login')">ç™»å½•</div>
            <div class="auth-tab" onclick="switchTab('register')">æ³¨å†Œ</div>
        </div>
        
        <div class="auth-form">
            <!-- ç™»å½•è¡¨å• -->
            <div class="login-form">
                <div class="form-group">
                    [ç³»ç»Ÿ]:æ¬¢è¿ğŸ‘ç™»å½•ï¼Œç§¯åˆ†å•†åŸå³å°†ä¸Šæ¶ï¼
                    <input type="text" id="loginUser" placeholder="ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <input type="password" id="loginPass" placeholder="å¯†ç ">
                </div>
                <button onclick="login()">ç™»å½•</button>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div class="register-form" style="display: none;">
                <div class="form-group">
                    [Damianè¶…çº§ç®¡ç†å‘˜Lv.3]:æœ€è¿‘æœåŠ¡å™¨é¢‘ç¹å—åˆ°æ”»å‡»ï¼Œæ³¨å†Œä¼šè¢«é™åˆ¶ï¼Œå¦‚æœæ— æ³•æ³¨å†Œè¯·åˆ·æ–°é¡µé¢ğŸ“ƒã€‚
                    <input type="text" id="registerUser" placeholder="ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <input type="password" id="registerPass" placeholder="å¯†ç ">
                </div>
                <button onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- é¦–é¡µ -->
    <div class="container dashboard">
        <h1>æ¬¢è¿, <span id="username"></span>!  20ç§¯åˆ†=1å…ƒ</h1>
        <div class="points">
            <span id="points">0</span> ç§¯åˆ†
        </div>
        <button class="checkin-btn" onclick="checkIn()" id="checkinBtn">æ¯æ—¥ç­¾åˆ°</button>
        <h3 style="margin: 2rem 0 1rem;">ç§¯åˆ†æ’è¡Œæ¦œ</h3>
        <div id="leaderboard"></div>
    </div>

    <!-- åå°ç®¡ç† -->
    <div class="container admin-dashboard" style="display: none;">
        <h1>åå°ç®¡ç†</h1>
        <div class="form-group">
            <input type="text" id="searchUser" placeholder="æœç´¢ç”¨æˆ·å" oninput="searchUser()">
        </div>
        <div class="user-list" id="userList"></div>
        <div id="userDetails" style="display: none;">
            <h2>ç”¨æˆ·ä¿¡æ¯</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="editUsername">
            </div>
            <div class="form-group">
                <label>å¯†ç :</label>
                <input type="text" id="editPassword">
            </div>
            <div class="form-group">
                <label>ç§¯åˆ†:</label>
                <input type="number" id="editPoints">
            </div>
            <div class="form-group">
                <label>çŠ¶æ€:</label>
                <select id="editStatus">
                    <option value="active">æ­£å¸¸</option>
                    <option value="banned">å°ç¦</option>
                </select>
            </div>
            <div class="form-group">
                <button onclick="updateUser()">ä¿å­˜æ›´æ”¹</button>
                <button class="danger" onclick="deleteUser()">åˆ é™¤ç”¨æˆ·</button>
                <button onclick="clearPoints()">æ¸…é™¤ç§¯åˆ†</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification"></div>

    <script>
        const GITEE = {
            repo: '8004',
            token: 'b5a96c2df3774e1a8ded0ff0cc54cdfa',
            owner: 'damian2021'
        }

        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'Aa814814123456'
        }

        let currentUser = null;
        let lastCheckinDate = null;

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Gitee API è¯·æ±‚
        // Gitee API è¯·æ±‚
async function giteeRequest(file, method = 'GET', content = '') {
    try {
        showLoading(true);
        const url = `https://gitee.com/api/v5/repos/${GITEE.owner}/${GITEE.repo}/contents/${file}`;
        
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `token ${GITEE.token}`
            }
        };

        if (method === 'PUT') {
            // è·å–æ–‡ä»¶çš„ SHAï¼ˆç”¨äºæ›´æ–°æ–‡ä»¶ï¼‰
            const existingFile = await fetch(url, {
                headers: {
                    'Authorization': `token ${GITEE.token}`
                }
            }).then(res => res.json());

            options.body = JSON.stringify({
                content: btoa(unescape(encodeURIComponent(content))), // Base64 ç¼–ç 
                message: 'Update data',
                sha: existingFile.sha // æä¾›æ–‡ä»¶çš„ SHA
            });
        }

        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`æ¥è‡ªDamiançš„severæ˜¾ç¤º:API é”™è¯¯: ${errorData.message || 'æœªçŸ¥é”™è¯¯'}`);
        }
        return response.json();
    } catch (error) {
        console.error('æ•°æ®åº“API è¯·æ±‚å¤±è´¥:', error);
        showNotification(`æ“ä½œå¤±è´¥ï¼Œè¯·è”ç³»Damianå¼€å‘è€…: ${error.message}`, 'danger');
        throw error;
    } finally {
        showLoading(false);
    }
}

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`.${tab}-form`).forEach(f => f.style.display = 'block');
            document.querySelectorAll(`.auth-tab[onclick*="${tab}"]`).forEach(t => t.classList.add('active'));
            
            if(tab === 'login') {
                document.querySelector('.register-form').style.display = 'none';
            } else {
                document.querySelector('.login-form').style.display = 'none';
            }
        }

        // ç™»å½•åŠŸèƒ½
        async function login() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;

            // ç®¡ç†å‘˜ç‰¹æ®ŠéªŒè¯
            if(user === ADMIN_CREDENTIALS.username) {
                if(pass === ADMIN_CREDENTIALS.password) {
                    currentUser = user;
                    document.querySelector('.auth-container').style.display = 'none';
                    document.querySelector('.admin-dashboard').style.display = 'block';
                    loadUserList();
                    return;
                } else {
                    return showNotification('ç®¡ç†å‘˜å¯†ç é”™è¯¯');
                }
            }

            // æ™®é€šç”¨æˆ·éªŒè¯
            const data = await giteeRequest('login.txt');
            const users = data.content ? atob(data.content).split('\n') : [];
            
            const userData = users.find(u => {
                const [uUser, uPass, status] = u.split(':');
                return uUser === user && uPass === pass && status !== 'banned';
            });

            if(userData) {
                currentUser = user;
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.dashboard').style.display = 'block';
                document.getElementById('username').textContent = user;
                loadDashboard();
            } else {
                showNotification('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œæˆ–è´¦å·è¢«å°ç¦');
            }
        }

        // æ³¨å†ŒåŠŸèƒ½
        async function register() {
            const user = document.getElementById('registerUser').value;
            const pass = document.getElementById('registerPass').value;

            // éªŒè¯ç”¨æˆ·å
            if(user.trim() === '') {
                return showNotification('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
            }

            // éªŒè¯ä¸­æ–‡å
            const chineseRegex = /[\u4e00-\u9fa5]/;
            if(chineseRegex.test(user)) {
                return showNotification('ç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡');
            }

            // éªŒè¯å¯†ç é•¿åº¦
            if(pass.length < 8) {
                return showNotification('å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦');
            }

            if(user === ADMIN_CREDENTIALS.username) {
                return showNotification('ä¸èƒ½æ³¨å†Œç®¡ç†å‘˜è´¦å·');
            }

            try {
                const data = await giteeRequest('login.txt');
                const users = data.content ? atob(data.content).split('\n') : [];

                if(users.some(u => u.split(':')[0] === user)) {
                    return showNotification('ç”¨æˆ·åå·²å­˜åœ¨');
                }

                await giteeRequest('login.txt', 'PUT', [...users, `${user}:${pass}:active`].join('\n'));
                showNotification('æ³¨å†ŒæˆåŠŸ');
                switchTab('login');
            } catch (error) {
                showNotification('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ç­¾åˆ°åŠŸèƒ½
        async function checkIn() {
            const today = new Date().toLocaleDateString();
            if(lastCheckinDate === today) {
                return showNotification('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†');
            }

            const data = await giteeRequest('star.txt');
            let records = data.content ? atob(data.content).split('\n') : [];
            
            const index = records.findIndex(r => r.startsWith(currentUser));
            const [user, points, lastDate] = index >= 0 ? records[index].split(':') : [currentUser, 0, ''];

            if(lastDate === today) {
                return showNotification('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†');
            }

            const newPoints = parseInt(points) + 2;
            if(index >= 0) {
                records[index] = `${user}:${newPoints}:${today}`;
            } else {
                records.push(`${user}:${newPoints}:${today}`);
            }

            await giteeRequest('star.txt', 'PUT', records.join('\n'));
            showNotification('ç­¾åˆ°æˆåŠŸ +2 ç§¯åˆ†', 'success');
            lastCheckinDate = today;
            loadDashboard();
        }

        // åŠ è½½é¦–é¡µæ•°æ®
        async function loadDashboard() {
            const data = await giteeRequest('star.txt');
            const records = data.content ? atob(data.content).split('\n') : [];
            
            // æ›´æ–°ç§¯åˆ†å’Œæ’è¡Œæ¦œ
            const userRecord = records.find(r => r.startsWith(currentUser)) || `${currentUser}:0`;
            document.getElementById('points').textContent = userRecord.split(':')[1];

            // ç”Ÿæˆæ’è¡Œæ¦œ
            const leaderboard = records.map(r => {
                const [user, points] = r.split(':');
                return { user, points: parseInt(points) };
            }).sort((a, b) => b.points - a.points);

            document.getElementById('leaderboard').innerHTML = leaderboard
                .map(u => `<div>${u.user} - ${u.points}</div>`)
                .join('');
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUserList() {
            const data = await giteeRequest('login.txt');
            const users = data.content ? atob(data.content).split('\n') : [];
            
            const userList = document.getElementById('userList');
            userList.innerHTML = users.map(u => {
                const [user, pass, status] = u.split(':');
                return `<div class="user-item" onclick="loadUserDetails('${user}')">${user}</div>`;
            }).join('');
        }

        // åŠ è½½ç”¨æˆ·è¯¦æƒ…
        async function loadUserDetails(username) {
            if(username === ADMIN_CREDENTIALS.username) {
                return showNotification('ä¸èƒ½ä¿®æ”¹ç®¡ç†å‘˜ä¿¡æ¯');
            }

            const data = await giteeRequest('login.txt');
            const users = data.content ? atob(data.content).split('\n') : [];
            
            const userData = users.find(u => u.startsWith(username));
            if(userData) {
                const [user, pass, status] = userData.split(':');
                document.getElementById('editUsername').value = user;
                document.getElementById('editPassword').value = pass;
                document.getElementById('editStatus').value = status || 'active';
                
                const starData = await giteeRequest('star.txt');
                const starRecords = starData.content ? atob(starData.content).split('\n') : [];
                const pointsRecord = starRecords.find(r => r.startsWith(user));
                document.getElementById('editPoints').value = pointsRecord ? pointsRecord.split(':')[1] : 0;
                
                document.getElementById('userDetails').style.display = 'block';
            } else {
                showNotification('ç”¨æˆ·æœªæ‰¾åˆ°');
            }
        }

        // æœç´¢ç”¨æˆ·
        async function searchUser() {
            const query = document.getElementById('searchUser').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(query) ? 'block' : 'none';
            });
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        async function updateUser() {
            const oldUsername = document.getElementById('editUsername').value;
            const newUsername = document.getElementById('editUsername').value;
            const newPassword = document.getElementById('editPassword').value;
            const newPoints = document.getElementById('editPoints').value;
            const newStatus = document.getElementById('editStatus').value;

            if(oldUsername === ADMIN_CREDENTIALS.username || newUsername === ADMIN_CREDENTIALS.username) {
                return showNotification('ä¸èƒ½ä¿®æ”¹ç®¡ç†å‘˜ä¿¡æ¯');
            }

            // æ›´æ–°ç™»å½•ä¿¡æ¯
            const loginData = await giteeRequest('login.txt');
            let users = loginData.content ? atob(loginData.content).split('\n') : [];
            const userIndex = users.findIndex(u => u.startsWith(oldUsername));
            if(userIndex >= 0) {
                users[userIndex] = `${newUsername}:${newPassword}:${newStatus}`;
                await giteeRequest('login.txt', 'PUT', users.join('\n'));
            }

            // æ›´æ–°ç§¯åˆ†ä¿¡æ¯
            const starData = await giteeRequest('star.txt');
            let starRecords = starData.content ? atob(starData.content).split('\n') : [];
            const starIndex = starRecords.findIndex(r => r.startsWith(oldUsername));
            if(starIndex >= 0) {
                starRecords[starIndex] = `${newUsername}:${newPoints}`;
                await giteeRequest('star.txt', 'PUT', starRecords.join('\n'));
            }

            showNotification('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ');
            loadUserList();
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser() {
            const username = document.getElementById('editUsername').value;
            
            if(username === ADMIN_CREDENTIALS.username) {
                return showNotification('ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜');
            }

            // åˆ é™¤ç™»å½•ä¿¡æ¯
            const loginData = await giteeRequest('login.txt');
            let users = loginData.content ? atob(loginData.content).split('\n') : [];
            users = users.filter(u => !u.startsWith(username));
            await giteeRequest('login.txt', 'PUT', users.join('\n'));

            // åˆ é™¤ç§¯åˆ†ä¿¡æ¯
            const starData = await giteeRequest('star.txt');
            let starRecords = starData.content ? atob(starData.content).split('\n') : [];
            starRecords = starRecords.filter(r => !r.startsWith(username));
            await giteeRequest('star.txt', 'PUT', starRecords.join('\n'));

            showNotification('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
            document.getElementById('userDetails').style.display = 'none';
            loadUserList();
        }

        // æ¸…é™¤ç”¨æˆ·ç§¯åˆ†
        async function clearPoints() {
            const username = document.getElementById('editUsername').value;
            
            if(username === ADMIN_CREDENTIALS.username) {
                return showNotification('ä¸èƒ½ä¿®æ”¹ç®¡ç†å‘˜ä¿¡æ¯');
            }

            const starData = await giteeRequest('star.txt');
            let starRecords = starData.content ? atob(starData.content).split('\n') : [];
            const starIndex = starRecords.findIndex(r => r.startsWith(username));
            if(starIndex >= 0) {
                starRecords[starIndex] = `${username}:0`;
                await giteeRequest('star.txt', 'PUT', starRecords.join('\n'));
            }

            showNotification('ç”¨æˆ·ç§¯åˆ†å·²æ¸…é›¶');
            loadUserDetails(username);
        }
    </script>
</body>
</html>
