<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分系统</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #fff;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .card h2 {
            margin-bottom: 20px;
            font-weight: bold;
        }
        .form-control {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            margin-bottom: 15px;
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .btn-primary {
            background: #28a745;
            border: none;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            transition: background 0.3s ease;
        }
        .btn-primary:hover {
            background: #218838;
        }
        .btn-secondary {
            background: #6c757d;
            border: none;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            transition: background 0.3s ease;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .leaderboard {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .leaderboard li {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            list-style: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div class="card" id="loginContainer">
        <h2>登录</h2>
        <input type="text" id="loginUsername" class="form-control" placeholder="用户名" required>
        <input type="password" id="loginPassword" class="form-control" placeholder="密码" required>
        <button class="btn btn-primary" onclick="login()">登录</button>
        <p class="mt-3">没有账号？<a href="#" onclick="showRegister()" class="text-white">注册</a></p>
    </div>

    <!-- 注册界面 -->
    <div class="card hidden" id="registerContainer">
        <h2>注册</h2>
        <input type="text" id="registerUsername" class="form-control" placeholder="用户名" required>
        <input type="password" id="registerPassword" class="form-control" placeholder="密码" required>
        <button class="btn btn-primary" onclick="register()">注册</button>
        <p class="mt-3">已有账号？<a href="#" onclick="showLogin()" class="text-white">登录</a></p>
    </div>

    <!-- 首页界面 -->
    <div class="card hidden" id="homeContainer">
        <h2>首页</h2>
        <p>积分: <span id="points" class="fw-bold">0</span></p>
        <button class="btn btn-primary" onclick="signIn()">签到</button>
        <h3 class="mt-4">积分排行榜</h3>
        <ul class="leaderboard" id="leaderboard"></ul>
    </div>

    <!-- 引入 Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const giteeRepo = '8004';
        const giteeToken = '247bbba741389d3b55d3d126e0a249f9';
        const giteeUser = 'damian2021';

        function showRegister() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
        }

        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/login.txt`, {
                headers: {
                    'Authorization': `token ${giteeToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const users = atob(data.content).split('\n');
                const user = users.find(u => u.split(':')[0] === username && u.split(':')[1] === password);
                if (user) {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('homeContainer').classList.remove('hidden');
                    loadPoints();
                    loadLeaderboard();
                } else {
                    alert('用户名或密码错误');
                }
            });
        }

        function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/login.txt`, {
                headers: {
                    'Authorization': `token ${giteeToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const users = atob(data.content).split('\n');
                const userExists = users.some(u => u.split(':')[0] === username);
                if (userExists) {
                    alert('用户名已存在');
                } else {
                    const newUser = `${username}:${password}`;
                    const newContent = btoa(users.concat(newUser).join('\n'));
                    fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/login.txt`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${giteeToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: newContent,
                            message: '添加新用户',
                            sha: data.sha
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('注册成功');
                            showLogin();
                        } else {
                            alert('注册失败');
                        }
                    });
                }
            });
        }

        function loadPoints() {
            fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/qq.txt`, {
                headers: {
                    'Authorization': `token ${giteeToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const pointsData = atob(data.content).split('\n');
                const userEntry = pointsData.find(p => p.split(':')[0] === document.getElementById('loginUsername').value);
                if (userEntry) {
                    document.getElementById('points').textContent = userEntry.split(':')[1];
                }
            });
        }

        function loadLeaderboard() {
            fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/qq.txt`, {
                headers: {
                    'Authorization': `token ${giteeToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const pointsData = atob(data.content).split('\n');
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '';
                
                // 排序时仅比较积分部分
                pointsData.sort((a, b) => {
                    const aPoints = parseInt(a.split(':')[1]);
                    const bPoints = parseInt(b.split(':')[1]);
                    return bPoints - aPoints;
                }).forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.split(':')[0]}: ${p.split(':')[1]} 分`;
                    leaderboard.appendChild(li);
                });
            });
        }

        function signIn() {
            const username = document.getElementById('loginUsername').value;
            const today = new Date().toISOString().split('T')[0]; // 获取当前日期（YYYY-MM-DD格式）

            fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/qq.txt`, {
                headers: {
                    'Authorization': `token ${giteeToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const pointsData = atob(data.content).split('\n');
                const userEntry = pointsData.find(p => p.split(':')[0] === username);
                
                // 检查是否今天已经签到过
                if (userEntry) {
                    const lastSignDate = userEntry.split(':')[2]; // 格式：用户名:积分:最后签到日期
                    if (lastSignDate === today) {
                        alert('今日已签到，请明天再来！');
                        return;
                    }
                }

                // 更新积分和签到日期
                let newPoints = 0;
                let updatedEntry = '';
                if (userEntry) {
                    newPoints = parseInt(userEntry.split(':')[1]) + 2;
                    updatedEntry = `${username}:${newPoints}:${today}`;
                    pointsData[pointsData.indexOf(userEntry)] = updatedEntry;
                } else {
                    newPoints = 2;
                    updatedEntry = `${username}:${newPoints}:${today}`;
                    pointsData.push(updatedEntry);
                }

                const newContent = btoa(pointsData.join('\n'));
                fetch(`https://gitee.com/api/v5/repos/${giteeUser}/${giteeRepo}/contents/qq.txt`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${giteeToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: newContent,
                        message: '更新积分',
                        sha: data.sha
                    })
                })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('points').textContent = newPoints;
                        loadLeaderboard();
                    } else {
                        alert('签到失败');
                    }
                });
            });
        }
    </script>
</body>
</html>
