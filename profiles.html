<div id="profileCenter" class="container glass-container mt-5 p-4" style="display: none;">
    <h2 class="text-center mb-4">个人中心</h2>
    
    <!-- 用户信息 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">用户信息</h5>
            <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" class="form-control" id="profileUsername" disabled>
            </div>
            <div class="mb-3">
                <label class="form-label">注册时间</label>
                <input type="text" class="form-control" id="profileRegisterDate" disabled>
            </div>
        </div>
    </div>

    <!-- 修改密码 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">修改密码</h5>
            <form id="changePasswordForm">
                <div class="mb-3">
                    <label class="form-label">当前密码</label>
                    <input type="password" class="form-control" id="currentPassword" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">新密码</label>
                    <input type="password" class="form-control" id="newPassword" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">确认新密码</label>
                    <input type="password" class="form-control" id="confirmNewPassword" required>
                </div>
                <button type="submit" class="btn feature-btn w-100">修改密码</button>
            </form>
        </div>
    </div>

    <!-- 账户操作 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">账户操作</h5>
            <button class="btn btn-danger w-100 mb-2" onclick="confirmDeleteAccount()">删除账户</button>
            <button class="btn btn-secondary w-100" onclick="logout()">注销登录</button>
        </div>
    </div>

    <!-- 返回按钮 -->
    <button class="btn feature-btn w-100" onclick="backToMain()">返回首页</button>

    <!-- 删除确认模态框 -->
    <div id="deleteConfirmModal" class="donate-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteModal()">×</span>
            <h4 class="mb-3">确认删除账户</h4>
            <p>此操作不可恢复，您确定要删除账户吗？</p>
            <div class="d-grid gap-2">
                <button class="btn btn-danger" onclick="deleteAccount()">确认删除</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 个人中心相关逻辑
    let currentUser = null;

    // 显示个人中心
    function showProfile() {
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('profileCenter').style.display = 'block';
        loadProfileData();
    }

    // 返回首页
    function backToMain() {
        document.getElementById('profileCenter').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
    }

    // 加载用户数据
    async function loadProfileData() {
        try {
            // 从Gitee获取用户数据
            const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/login.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
            const data = await response.json();
            const users = atob(data.content).split('\n');
            
            const userData = users.find(u => u.startsWith(currentUser + ':'));
            if (userData) {
                const [username, password, registerDate] = userData.split(':');
                document.getElementById('profileUsername').value = username;
                document.getElementById('profileRegisterDate').value = new Date(registerDate).toLocaleString();
            }
        } catch (error) {
            console.error('加载用户数据失败:', error);
        }
    }

    // 修改密码
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword !== confirmNewPassword) {
            alert('两次输入的新密码不一致');
            return;
        }

        try {
            // 获取当前用户数据
            const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/login.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
            const data = await response.json();
            let users = atob(data.content).split('\n');

            // 验证并更新密码
            const userIndex = users.findIndex(u => u.startsWith(currentUser + ':'));
            if (userIndex !== -1) {
                const [username, oldPassword, registerDate] = users[userIndex].split(':');
                if (oldPassword !== currentPassword) {
                    alert('当前密码错误');
                    return;
                }

                users[userIndex] = `${username}:${newPassword}:${registerDate}`;
                await updateUserData(users);
                alert('密码修改成功');
            }
        } catch (error) {
            console.error('修改密码失败:', error);
        }
    });

    // 更新用户数据
    async function updateUserData(newUsers) {
        const content = btoa(newUsers.join('\n'));
        const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/login.txt', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                access_token: '247bbba741389d3b55d3d126e0a249f9',
                content: content,
                message: '更新用户数据',
                sha: await getFileSHA()
            })
        });
        return response.json();
    }

    // 注销登录
    function logout() {
        currentUser = null;
        document.getElementById('profileCenter').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
    }

    // 删除账户
    async function deleteAccount() {
        try {
            // 获取当前用户数据
            const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/login.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
            const data = await response.json();
            let users = atob(data.content).split('\n');

            // 删除用户
            const newUsers = users.filter(u => !u.startsWith(currentUser + ':'));
            await updateUserData(newUsers);
            alert('账户删除成功');
            logout();
        } catch (error) {
            console.error('删除账户失败:', error);
        }
    }

    // 删除确认
    function confirmDeleteAccount() {
        document.getElementById('deleteConfirmModal').style.display = 'block';
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
    }

    // 获取文件SHA
    async function getFileSHA() {
        const response = await fetch('https://gitee.com/api/v5/repos/damian2021/8004/contents/login.txt?access_token=247bbba741389d3b55d3d126e0a249f9');
        const data = await response.json();
        return data.sha;
    }
</script>
